-- Save in your existing Postgres DB used for chat sessions.

-- evaluation_results table
CREATE TABLE evaluation_results (
  id SERIAL PRIMARY KEY,
  session_id TEXT NOT NULL,
  user_id TEXT NULL,
  question TEXT NOT NULL,
  context TEXT NULL,
  llm_answer TEXT NOT NULL,
  ground_truth TEXT NULL,
  relevance_score FLOAT,
  bert_score FLOAT,
  llm_rubric_score FLOAT,
  combined_score FLOAT,
  passed BOOLEAN,
  evaluation_timestamp TIMESTAMP WITH TIME ZONE DEFAULT now(),
  evaluation_details JSONB, -- store full debug data / neighbors, embeddings omitted
  action_taken TEXT -- e.g., "none", "regenerated", "flagged_for_review"
);

-- ground truth table
CREATE TABLE ground_truths (
  id SERIAL PRIMARY KEY,
  question TEXT NOT NULL,
  context TEXT NULL,
  ground_truth TEXT NOT NULL,
  created_by TEXT,
  verified BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  verified_at TIMESTAMP WITH TIME ZONE
);


------------------------------------------------
-- evalution detail field
-- 会长这样
{
  "initial_relevance": 0.48,
  "initial_bert": 0.32,
  "initial_rubric": 0.51,
  "final_relevance": 0.55,
  "final_bert": 0.35,
  "final_rubric": 0.65,
  "rationale": "Answer is mostly useful but misses an important term. Suggest adding example.",
  "regen_reason": "low_combined_score",
  "regen_attempts": 1
}
-- Aggregate per-session report: query SELECT * FROM evaluation_results WHERE session_id = '...' ORDER BY evaluation_timestamp.